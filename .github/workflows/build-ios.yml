name: Build Chromium iOS (Unsigned)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      target:
        description: 'Build target (chrome, content_shell, ios_web_shell)'
        required: true
        default: 'chrome'
        type: choice
        options:
        - chrome
        - content_shell
        - ios_web_shell
      ios_version:
        description: 'Minimum iOS version requirement'
        required: true
        default: '15.0'
        type: choice
        options:
        - '13.0'
        - '14.0'
        - '15.0'
        - '16.0'
        - '17.0'

jobs:
  build:
    name: Build Chromium iOS
    runs-on: macos-13
    timeout-minutes: 480  # 8 hours timeout for large builds
    
    env:
      DEVELOPER_DIR: /Applications/Xcode_15.0.app/Contents/Developer
      
    steps:
    - name: Setup Xcode version
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.0'
        
    - name: Accept Xcode license
      run: |
        sudo xcodebuild -license accept
        
    - name: Check iOS Simulator
      run: |
        xcrun simctl list runtimes | head -10
        
    - name: Show system information
      run: |
        xcodebuild -version
        xcode-select -p
        system_profiler SPSoftwareDataType
        df -h
        
    - name: Install depot_tools
      run: |
        cd $HOME
        if [ ! -d "depot_tools" ]; then
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
        fi
        echo "$HOME/depot_tools" >> $GITHUB_PATH
        echo "$HOME/depot_tools/python-bin" >> $GITHUB_PATH
        
    - name: Setup depot_tools environment
      run: |
        export PATH="$HOME/depot_tools:$HOME/depot_tools/python-bin:$PATH"
        
        # Configure git for better progress display
        git config --global progress.status always
        git config --global core.preloadindex true
        git config --global transfer.fsckObjects false
        git config --global fetch.writeCommitGraph true
        
        gclient --version
        
    - name: Create chromium directory and fetch code
      run: |
        mkdir -p $HOME/chromium
        cd $HOME/chromium
        export PATH="$HOME/depot_tools:$HOME/depot_tools/python-bin:$PATH"
        
        # Show fetch progress information
        echo "ğŸš€ Starting Chromium iOS source download..."
        echo "ğŸ“¦ Expected download size: ~15-30GB (without git history)"
        echo "â±ï¸  Estimated time: 30min - 6hrs (depending on connection speed)"
        echo "ğŸ”„ Git progress will be shown during download"
        echo "Started at: $(date)"
        
        # Fetch Chromium iOS source with progress monitoring
        echo "Running: fetch --no-history ios"
        
        # Start fetch in background and monitor progress
        fetch --no-history ios &
        FETCH_PID=$!
        
        # Monitor progress while fetch is running
        echo "ğŸ“Š Monitoring download progress..."
        COUNTER=0
        while kill -0 $FETCH_PID 2>/dev/null; do
          sleep 60  # Check every minute
          COUNTER=$((COUNTER + 1))
          
          if [ -d "src" ]; then
            SIZE=$(du -sh src 2>/dev/null | cut -f1)
            echo "â³ Progress: ${SIZE} downloaded (${COUNTER} minutes elapsed) - $(date)"
            
            # Show some directory sizes to indicate progress
            if [ -d "src/third_party" ]; then
              THIRD_PARTY_SIZE=$(du -sh src/third_party 2>/dev/null | cut -f1)
              echo "   ğŸ“¦ third_party: ${THIRD_PARTY_SIZE}"
            fi
            
            if [ -d "src/chrome" ]; then
              CHROME_SIZE=$(du -sh src/chrome 2>/dev/null | cut -f1)
              echo "   ğŸŒ chrome: ${CHROME_SIZE}"
            fi
          else
            echo "â³ Setting up... (${COUNTER} minutes elapsed) - $(date)"
          fi
          
          # Show disk usage every 10 minutes
          if [ $((COUNTER % 10)) -eq 0 ]; then
            echo "ğŸ’¾ Disk usage:"
            df -h | grep -E "(Filesystem|/dev/disk)"
          fi
        done
        
        # Wait for fetch to complete and get exit code
        wait $FETCH_PID
        FETCH_EXIT_CODE=$?
        
        if [ $FETCH_EXIT_CODE -eq 0 ]; then
          echo "âœ… Fetch completed successfully at: $(date)"
          echo "â±ï¸  Total time: ${COUNTER} minutes"
        else
          echo "âŒ Fetch failed with exit code: $FETCH_EXIT_CODE"
          exit $FETCH_EXIT_CODE
        fi
        
    - name: Check source code size and structure
      run: |
        cd $HOME/chromium
        echo "ğŸ“Š Analyzing Chromium source code size..."
        echo "Total Chromium directory size:"
        du -sh .
        
        echo -e "\nSource directory breakdown:"
        du -sh src
        
        echo -e "\nLargest subdirectories in src/:"
        du -sh src/*/ 2>/dev/null | sort -hr | head -15
        
        echo -e "\nLargest third_party components:"
        du -sh src/third_party/*/ 2>/dev/null | sort -hr | head -10
        
        echo -e "\nDisk usage summary:"
        df -h
        
    - name: Check available SDKs and setup build
      run: |
        cd $HOME/chromium/src
        export PATH="$HOME/depot_tools:$HOME/depot_tools/python-bin:$PATH"
        
        # Check available iOS SDKs
        echo "ğŸ” Checking available iOS SDKs..."
        IOS_SDK_PATH="/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs"
        XCODE_SDK_PATH="/Applications/Xcode_15.0.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs"
        
        echo "Looking for iOS SDKs in:"
        echo "  $IOS_SDK_PATH"
        echo "  $XCODE_SDK_PATH"
        
        # List available iOS SDKs
        if [ -d "$IOS_SDK_PATH" ]; then
          echo "iOS SDKs found:"
          ls -la "$IOS_SDK_PATH" | grep -i ios || echo "  No iOS SDKs found in default location"
        fi
        
        if [ -d "$XCODE_SDK_PATH" ]; then
          echo "iOS SDKs in Xcode_15.0:"
          ls -la "$XCODE_SDK_PATH" | grep -i ios || echo "  No iOS SDKs found in Xcode_15.0"
        fi
        
        # Check macOS SDKs for comparison
        echo "Available macOS SDKs:"
        ls -la /Applications/Xcode_15.0.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/
        
        # Create .setup-gn config for unsigned builds
        IOS_VERSION="${{ github.event.inputs.ios_version || '15.0' }}"
        echo "Setting iOS deployment target to: $IOS_VERSION"
        
        cat > .setup-gn << EOF
        [gn_args]
        target_os="ios"
        target_platform="ios"
        ios_enable_code_signing=false
        ios_deployment_target="$IOS_VERSION"
        is_debug=false
        is_component_build=false
        symbol_level=1
        enable_dsyms=false
        use_blink=true
        ios_code_signing_identity=""
        ios_app_bundle_id_prefix="org.chromium"
        # Force iOS SDK usage
        ios_sdk_path=""
        mac_sdk_min="14.0"
        EOF
        
        # Run setup-gn.py to configure build
        python3 ios/build/tools/setup-gn.py
        
    - name: Build Chromium iOS
      run: |
        cd $HOME/chromium/src
        export PATH="$HOME/depot_tools:$HOME/depot_tools/python-bin:$PATH"
        
        TARGET="${{ github.event.inputs.target || 'chrome' }}"
        echo "Building target: $TARGET"
        
        # Build for iOS device (unsigned)
        autoninja -C out/Release-iphoneos $TARGET
        
    - name: Create unsigned IPA
      run: |
        cd $HOME/chromium/src
        TARGET="${{ github.event.inputs.target || 'chrome' }}"
        
        # Find the built app
        APP_PATH="out/Release-iphoneos/${TARGET}.app"
        if [ ! -d "$APP_PATH" ]; then
          echo "App not found at $APP_PATH"
          ls -la out/Release-iphoneos/
          exit 1
        fi
        
        # Create Payload directory and copy app
        mkdir -p Payload
        cp -R "$APP_PATH" Payload/
        
        # Create IPA (it's just a zip file)
        zip -r "${TARGET}-unsigned-$(date +%Y%m%d-%H%M%S).ipa" Payload
        
        # Clean up
        rm -rf Payload
        
    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: chromium-ios-unsigned-ipa
        path: ${{ github.workspace }}/../chromium/src/*.ipa
        retention-days: 7
        
    - name: Show build information
      run: |
        cd $HOME/chromium/src
        echo "Build completed successfully!"
        echo "Generated IPA files:"
        ls -la *.ipa
        echo "File sizes:"
        du -h *.ipa
        echo "Disk usage:"
        df -h
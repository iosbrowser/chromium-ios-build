name: Build Chromium iOS (Unsigned)

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Build target (chrome, content_shell, ios_web_shell)'
        required: true
        default: 'chrome'
        type: choice
        options:
        - chrome
        - content_shell
        - ios_web_shell
      reuse_artifacts:
        description: 'Reuse artifacts from previous workflows (within 7 days)'
        required: false
        default: false
        type: boolean

jobs:
  build_modules:
    name: "Build ${{ matrix.module }}"
    runs-on: macos-15
    timeout-minutes: 300 # 5 hours timeout for building a module
    strategy:
      fail-fast: false
      matrix:
        module: [ "base", "net", "services", "third_party/blink/public:blink_headers", "content/browser", "content/renderer", "content/common" ]

    env:
      DEVELOPER_DIR: /Applications/Xcode_26.0.app/Contents/Developer
      DEPOT_TOOLS_PATH: /Users/runner/depot_tools
      CHROMIUM_PATH: /Users/runner/chromium

    steps:
    - name: Set sanitized module name
      id: sanitize
      run: |
        SANITIZED_NAME=$(echo "${{ matrix.module }}" | tr ':/' '_')
        echo "name=$SANITIZED_NAME" >> $GITHUB_OUTPUT
        echo "Sanitized module name: $SANITIZED_NAME"
    
    - name: Check for existing artifacts
      id: check_artifacts
      if: ${{ github.event.inputs.reuse_artifacts == 'true' }}
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Calculate date 7 days ago
        SEVEN_DAYS_AGO=$(date -d '7 days ago' '+%Y-%m-%dT%H:%M:%SZ' 2>/dev/null || date -v-7d '+%Y-%m-%dT%H:%M:%SZ')
        
        # Search for recent workflow runs
        echo "Searching for artifacts from workflows in the last 7 days..."
        
        # Get recent successful workflow runs
        WORKFLOWS=$(gh api repos/${{ github.repository }}/actions/runs \
          --jq ".workflow_runs[] | select(.status == \"completed\" and .conclusion == \"success\" and .created_at >= \"$SEVEN_DAYS_AGO\") | .id" \
          | head -10)
        
        ARTIFACT_NAME="build-output-${{ steps.sanitize.outputs.name }}"
        FOUND_ARTIFACT=""
        LATEST_DATE=""
        
        for run_id in $WORKFLOWS; do
          echo "Checking workflow run: $run_id"
          
          # Check if this run has our artifact
          ARTIFACT_INFO=$(gh api repos/${{ github.repository }}/actions/runs/$run_id/artifacts \
            --jq ".artifacts[] | select(.name == \"$ARTIFACT_NAME\") | {id: .id, created_at: .created_at, expired: .expired}")
          
          if [ -n "$ARTIFACT_INFO" ] && [ "$(echo "$ARTIFACT_INFO" | jq -r .expired)" = "false" ]; then
            ARTIFACT_DATE=$(echo "$ARTIFACT_INFO" | jq -r .created_at)
            ARTIFACT_ID=$(echo "$ARTIFACT_INFO" | jq -r .id)
            
            echo "Found artifact: $ARTIFACT_ID created at $ARTIFACT_DATE"
            
            # Check if this is the most recent one
            if [ -z "$LATEST_DATE" ] || [ "$ARTIFACT_DATE" \> "$LATEST_DATE" ]; then
              LATEST_DATE="$ARTIFACT_DATE"
              FOUND_ARTIFACT="$ARTIFACT_ID"
            fi
          fi
        done
        
        if [ -n "$FOUND_ARTIFACT" ]; then
          echo "Using most recent artifact: $FOUND_ARTIFACT from $LATEST_DATE"
          echo "artifact_found=true" >> $GITHUB_OUTPUT
          echo "artifact_id=$FOUND_ARTIFACT" >> $GITHUB_OUTPUT
        else
          echo "No suitable artifact found, will build from scratch"
          echo "artifact_found=false" >> $GITHUB_OUTPUT
        fi

    - name: Download existing artifact
      if: ${{ steps.check_artifacts.outputs.artifact_found == 'true' }}
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Downloading artifact: ${{ steps.check_artifacts.outputs.artifact_id }}"
        gh api repos/${{ github.repository }}/actions/artifacts/${{ steps.check_artifacts.outputs.artifact_id }}/zip \
          > artifact.zip
        
        mkdir -p ${{ env.CHROMIUM_PATH }}/src/out/
        unzip -o artifact.zip -d ${{ env.CHROMIUM_PATH }}/src/out/
        rm artifact.zip
        
        echo "Artifact downloaded and extracted successfully"

    - name: Setup Xcode version
      if: ${{ steps.check_artifacts.outputs.artifact_found != 'true' }}
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '26.0'

    - name: Accept Xcode license
      if: ${{ steps.check_artifacts.outputs.artifact_found != 'true' }}
      run: |
        sudo xcodebuild -license accept

    - name: Install depot_tools
      if: ${{ steps.check_artifacts.outputs.artifact_found != 'true' }}
      run: |
        cd $HOME
        if [ ! -d "depot_tools" ]; then
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
        fi
        echo "$HOME/depot_tools" >> $GITHUB_PATH
        echo "$HOME/depot_tools/python-bin" >> $GITHUB_PATH

    - name: Fetch Chromium Source
      if: ${{ steps.check_artifacts.outputs.artifact_found != 'true' }}
      run: |
        mkdir -p $HOME/chromium
        cd $HOME/chromium
        export PATH="$HOME/depot_tools:$HOME/depot_tools/python-bin:$PATH"
        fetch --no-history ios
    
    - name: Setup gn
      if: ${{ steps.check_artifacts.outputs.artifact_found != 'true' }}
      run: |
        cd ${{ env.CHROMIUM_PATH }}/src
        export PATH="$HOME/depot_tools:$HOME/depot_tools/python-bin:$PATH"
        cd ${{ env.CHROMIUM_PATH }}
        cat > .setup-gn << EOF
        [gn_args]
        target_os="ios"
        target_cpu="arm64"
        target_platform="iphoneos"
        ios_enable_code_signing=false
        is_debug=false
        is_component_build=false
        symbol_level=1
        enable_dsyms=false
        use_blink=true
        ios_chromium_bundle_id="org.chromium.chrome.ios.dev"
        ios_content_shell_bundle_identifier="org.chromium.content-shell"
        ios_code_signing_identity=""
        ios_app_bundle_id_prefix="org.chromium"
        EOF
        cd ${{ env.CHROMIUM_PATH }}/src
        python3 ios/build/tools/setup-gn.py

    - name: Build module
      if: ${{ steps.check_artifacts.outputs.artifact_found != 'true' }}
      run: |
        cd ${{ env.CHROMIUM_PATH }}/src
        export PATH="$HOME/depot_tools:$HOME/depot_tools/python-bin:$PATH"
        autoninja -C out/Release-iphoneos ${{ matrix.module }}

    - name: Upload partial build output
      uses: actions/upload-artifact@v4
      with:
        name: build-output-${{ steps.sanitize.outputs.name }}
        path: ${{ env.CHROMIUM_PATH }}/src/out/
        retention-days: 1

  combine_and_cache:
    name: "Combine and Cache Build Outputs"
    needs: build_modules
    runs-on: macos-15
    timeout-minutes: 60
    steps:
      - name: Create directories for artifacts and cache
        run: |
          mkdir -p /Users/runner/partial-builds
          mkdir -p /Users/runner/chromium/src/out
      - name: Download all partial build outputs
        uses: actions/download-artifact@v4
        with:
          path: /Users/runner/partial-builds
      - name: Combine build outputs
        run: |
          # The downloaded artifacts are in subdirectories named after the artifact
          for dir in /Users/runner/partial-builds/build-output-*; do
            if [ -d "$dir" ]; then
              rsync -av "$dir"/ /Users/runner/chromium/src/out/
            fi
          done
      - name: Cache combined build output
        uses: actions/cache@v4
        with:
          path: /Users/runner/chromium/src/out/
          key: combined-build-output-${{ github.run_id }}

  build_final_target:
    name: "Build Final Target"
    needs: combine_and_cache
    runs-on: macos-15
    timeout-minutes: 180 # 3 hours timeout for final build

    env:
      DEVELOPER_DIR: /Applications/Xcode_26.0.app/Contents/Developer
      DEPOT_TOOLS_PATH: /Users/runner/depot_tools
      CHROMIUM_PATH: /Users/runner/chromium

    steps:
    - name: Setup Xcode version
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '26.0'

    - name: Install depot_tools
      run: |
        cd $HOME
        if [ ! -d "depot_tools" ]; then
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
        fi
        echo "$HOME/depot_tools" >> $GITHUB_PATH
        echo "$HOME/depot_tools/python-bin" >> $GITHUB_PATH

    - name: Fetch Chromium Source
      run: |
        mkdir -p $HOME/chromium
        cd $HOME/chromium
        export PATH="$HOME/depot_tools:$HOME/depot_tools/python-bin:$PATH"
        fetch --no-history ios

    - name: Restore combined build output
      uses: actions/cache@v4
      with:
        path: ${{ env.CHROMIUM_PATH }}/src/out/
        key: combined-build-output-${{ github.run_id }}
        fail-on-cache-miss: true

    - name: Build final target
      run: |
        cd ${{ env.CHROMIUM_PATH }}/src
        export PATH="$HOME/depot_tools:$HOME/depot_tools/python-bin:$PATH"
        TARGET="${{ github.event.inputs.target || 'chrome' }}"
        echo "Building final target: $TARGET"
        # We need to run gn gen again to ensure build configuration is correct
        python3 ios/build/tools/setup-gn.py
        autoninja -C out/Release-iphoneos $TARGET

  package_ipa:
    name: "Package and Upload IPA"
    needs: build_final_target
    runs-on: macos-15
    timeout-minutes: 60 # 1 hour timeout for packaging

    env:
      CHROMIUM_PATH: /Users/runner/chromium

    steps:
    - name: Fetch Chromium Source
      run: |
        mkdir -p $HOME/chromium
        cd $HOME/chromium
        export PATH="$HOME/depot_tools:$HOME/depot_tools/python-bin:$PATH"
        # Only need a shallow copy for packaging
        git clone --depth 1 https://chromium.googlesource.com/chromium/src.git ${{ env.CHROMIUM_PATH }}/src

    - name: Restore combined build output
      uses: actions/cache@v4
      with:
        path: ${{ env.CHROMIUM_PATH }}/src/out/
        key: combined-build-output-${{ github.run_id }}
        fail-on-cache-miss: true

    - name: Create unsigned IPA
      run: |
        cd ${{ env.CHROMIUM_PATH }}/src
        TARGET="${{ github.event.inputs.target || 'chrome' }}"
        
        APP_PATH="out/Release-iphoneos/${TARGET}.app"
        if [ ! -d "$APP_PATH" ]; then
          echo "App not found at $APP_PATH"
          exit 1
        fi
        
        mkdir -p Payload
        cp -R "$APP_PATH" Payload/
        
        zip -r "${TARGET}-unsigned-$(date +%Y%m%d-%H%M%S).ipa" Payload
        
        rm -rf Payload

    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: chromium-ios-unsigned-ipa
        path: ${{ env.CHROMIUM_PATH }}/src/*.ipa
        retention-days: 7

    - name: Debug with tmate on failure
      if: failure()
      uses: mxschmitt/action-tmate@v3
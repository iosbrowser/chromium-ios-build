name: Build Chromium iOS (Unsigned)

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Build target (chrome, content_shell, ios_web_shell)'
        required: true
        default: 'chrome'
        type: choice
        options:
        - chrome
        - content_shell
        - ios_web_shell
      cache_id:
        description: 'A unique ID for the gclient cache. If provided, the cache will be used. Leave empty to build without cache.'
        required: false
        default: ''
        type: string

jobs:
  prepare_source:
    name: "Prepare Chromium Source ${{ github.event.inputs.cache_id && format('(Cache: {0})', github.event.inputs.cache_id) }}"
    runs-on: macos-15
    timeout-minutes: 120 # 2 hours timeout for fetching source

    env:
      DEVELOPER_DIR: /Applications/Xcode_26.0.app/Contents/Developer
      DEPOT_TOOLS_PATH: /Users/runner/depot_tools
      CHROMIUM_PATH: /Users/runner/chromium
      GCLIENT_CACHE_PATH: /Users/runner/gclient_cache

    steps:
    - name: Cache gclient cache
      if: github.event.inputs.cache_id != ''
      uses: actions/cache@v4
      with:
        path: ${{ env.GCLIENT_CACHE_PATH }}
        key: ${{ runner.os }}-${{ github.event.inputs.cache_id }}
        restore-keys: |
          ${{ runner.os }}-${{ github.event.inputs.cache_id }}

    - name: Setup Xcode version
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '26.0'

    - name: Accept Xcode license
      run: |
        sudo xcodebuild -license accept

    - name: Install depot_tools
      run: |
        cd $HOME
        if [ ! -d "depot_tools" ]; then
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
        fi
        echo "$HOME/depot_tools" >> $GITHUB_PATH
        echo "$HOME/depot_tools/python-bin" >> $GITHUB_PATH

    - name: Setup depot_tools environment
      run: |
        export PATH="$HOME/depot_tools:$HOME/depot_tools/python-bin:$PATH"
        git config --global progress.status always
        git config --global core.preloadindex true
        git config --global transfer.fsckObjects false
        git config --global fetch.writeCommitGraph true
        gclient --version

    - name: Create chromium directory and fetch code
      run: |
        mkdir -p $HOME/chromium
        cd $HOME/chromium
        export PATH="$HOME/depot_tools:$HOME/depot_tools/python-bin:$PATH"
        fetch --no-history ios
        
    - name: Setup gn
      run: |
        cd ${{ env.CHROMIUM_PATH }}/src
        export PATH="$HOME/depot_tools:$HOME/depot_tools/python-bin:$PATH"
        
        # Create .setup-gn config for unsigned builds
        cd ${{ env.CHROMIUM_PATH }}
        
        cat > .setup-gn << EOF
        [gn_args]
        target_os="ios"
        target_cpu="arm64"
        target_platform="iphoneos"
        ios_enable_code_signing=false
        is_debug=false
        is_component_build=false
        symbol_level=1
        enable_dsyms=false
        use_blink=true
        ios_chromium_bundle_id="org.chromium.chrome.ios.dev"
        ios_content_shell_bundle_identifier="org.chromium.content-shell"
        ios_code_signing_identity=""
        ios_app_bundle_id_prefix="org.chromium"
        EOF

        cd ${{ env.CHROMIUM_PATH }}/src
        
        # Run setup-gn.py to configure build. It will find the .setup-gn file in the parent directory.
        python3 ios/build/tools/setup-gn.py

    - name: Upload Chromium source artifact
      uses: actions/upload-artifact@v4
      with:
        name: chromium-source
        path: ${{ env.CHROMIUM_PATH }}
        retention-days: 1

  build_modules:
    name: "Build ${{ matrix.module }}"
    needs: prepare_source
    runs-on: macos-15
    timeout-minutes: 300 # 5 hours timeout for building a module
    strategy:
      fail-fast: false
      matrix:
        module: [ "base", "net", "ui", "content", "blink", "services" ]

    env:
      DEVELOPER_DIR: /Applications/Xcode_26.0.app/Contents/Developer
      DEPOT_TOOLS_PATH: /Users/runner/depot_tools
      CHROMIUM_PATH: /Users/runner/chromium

    steps:
    - name: Setup Xcode version
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '26.0'

    - name: Install depot_tools
      run: |
        cd $HOME
        if [ ! -d "depot_tools" ]; then
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
        fi
        echo "$HOME/depot_tools" >> $GITHUB_PATH
        echo "$HOME/depot_tools/python-bin" >> $GITHUB_PATH

    - name: Download Chromium source artifact
      uses: actions/download-artifact@v4
      with:
        name: chromium-source
        path: ${{ env.CHROMIUM_PATH }}

    - name: Cache build output
      uses: actions/cache@v4
      with:
        path: ${{ env.CHROMIUM_PATH }}/src/out/
        key: ${{ runner.os }}-build-output-${{ github.run_id }}-${{ matrix.module }}
        restore-keys: |
          ${{ runner.os }}-build-output-${{ github.run_id }}-

    - name: Build module
      run: |
        cd ${{ env.CHROMIUM_PATH }}/src
        export PATH="$HOME/depot_tools:$HOME/depot_tools/python-bin:$PATH"
        autoninja -C out/Release-iphoneos ${{ matrix.module }}

  build_final_target:
    name: "Build Final Target"
    needs: build_modules
    runs-on: macos-15
    timeout-minutes: 180 # 3 hours timeout for final build

    env:
      DEVELOPER_DIR: /Applications/Xcode_26.0.app/Contents/Developer
      DEPOT_TOOLS_PATH: /Users/runner/depot_tools
      CHROMIUM_PATH: /Users/runner/chromium

    steps:
    - name: Setup Xcode version
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '26.0'

    - name: Install depot_tools
      run: |
        cd $HOME
        if [ ! -d "depot_tools" ]; then
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
        fi
        echo "$HOME/depot_tools" >> $GITHUB_PATH
        echo "$HOME/depot_tools/python-bin" >> $GITHUB_PATH

    - name: Download Chromium source artifact
      uses: actions/download-artifact@v4
      with:
        name: chromium-source
        path: ${{ env.CHROMIUM_PATH }}

    - name: Restore build output cache
      uses: actions/cache@v4
      with:
        path: ${{ env.CHROMIUM_PATH }}/src/out/
        key: ${{ runner.os }}-build-output-${{ github.run_id }}-dummy # This key won't match, forcing restore from restore-keys
        restore-keys: |
          ${{ runner.os }}-build-output-${{ github.run_id }}-

    - name: Build final target
      run: |
        cd ${{ env.CHROMIUM_PATH }}/src
        export PATH="$HOME/depot_tools:$HOME/depot_tools/python-bin:$PATH"
        TARGET="${{ github.event.inputs.target || 'chrome' }}"
        echo "Building final target: $TARGET"
        autoninja -C out/Release-iphoneos $TARGET
    
    - name: Upload build output artifact
      uses: actions/upload-artifact@v4
      with:
        name: build-output
        path: ${{ env.CHROMIUM_PATH }}/src/out/
        retention-days: 1

  package_ipa:
    name: "Package and Upload IPA"
    needs: build_final_target
    runs-on: macos-15
    timeout-minutes: 60 # 1 hour timeout for packaging

    env:
      CHROMIUM_PATH: /Users/runner/chromium

    steps:
    - name: Download Chromium source artifact
      uses: actions/download-artifact@v4
      with:
        name: chromium-source
        path: ${{ env.CHROMIUM_PATH }}
        
    - name: Download build output artifact
      uses: actions/download-artifact@v4
      with:
        name: build-output
        path: ${{ env.CHROMIUM_PATH }}/src/out/

    - name: Create unsigned IPA
      run: |
        cd ${{ env.CHROMIUM_PATH }}/src
        TARGET="${{ github.event.inputs.target || 'chrome' }}"
        
        # Find the built app
        APP_PATH="out/Release-iphoneos/${TARGET}.app"
        if [ ! -d "$APP_PATH" ]; then
          echo "App not found at $APP_PATH"
          ls -la out/Release-iphoneos/
          exit 1
        fi
        
        # Create Payload directory and copy app
        mkdir -p Payload
        cp -R "$APP_PATH" Payload/
        
        # Create IPA (it's just a zip file)
        zip -r "${TARGET}-unsigned-$(date +%Y%m%d-%H%M%S).ipa" Payload
        
        # Clean up
        rm -rf Payload

    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: chromium-ios-unsigned-ipa
        path: ${{ env.CHROMIUM_PATH }}/src/*.ipa
        retention-days: 7

    - name: Show build information
      run: |
        cd ${{ env.CHROMIUM_PATH }}/src
        echo "Build completed successfully!"
        echo "Generated IPA files:"
        ls -la *.ipa

    - name: Debug with tmate on failure
      if: failure()
      uses: mxschmitt/action-tmate@v3